<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Swago</title>
    <link rel="stylesheet" href="css/dashboard.css">
    
</head>
<body>

    <header class="navbar">
        <div class="navbar-logo">
            <a href="index.html">
                <img src="images/logo2bg.png" alt="Swago Logo">
            </a>
        </div>
        <nav class="navbar-menu">
            <a href="index.html">Ana Sayfa</a>
            <a href="dashboard.html" class="active">Dashboard</a>
            <a href="#" id="logout-button">Çıkış Yap</a>
        </nav>
    </header>

    <div class="dashboard-container">
        <div class="tabs">
            <button class="tab active" data-tab="profile-tab">Profil Bilgilerim</button>
            <button class="tab" data-tab="listings-tab">Mevcut İlanlar</button>
            <button class="tab" data-tab="my-listings-tab">İlanlarım</button>

            <button class="tab" data-tab="add-listing-tab">İlan Ekle</button>
            <button class="tab" data-tab="traded-listings-tab">Takaslanan İlanlar</button>
            <button class="tab" data-tab="inbox-tab">Gelen Mesajlar</button>
            

        </div>
    
        <div id="profile-tab" class="tab-content active">
            <div class="profile-container">
                <div class="profile-avatar">
                    <div class="token-circle">
                        <span id="profile-balance">Yükleniyor...</span>
                    </div>
                </div>
                <div class="profile-details">
                    <h2 id="profile-name">Ad Soyad: Yükleniyor...</h2>
                    <p><strong>Email:</strong> <span id="profile-email">Yükleniyor...</span></p>
                    <p><strong>Doğum Tarihi:</strong> <span id="profile-dob">Yükleniyor...</span></p>
                    <p><strong>Yetenekler:</strong> <span id="profile-skills">Yükleniyor...</span></p>
                    <button class="button" id="update-profile-button">Güncelle</button>
                </div>
            </div>
            <div id="update-profile-form" class="update-form" style="display: none;">
                <h3>Bilgileri Güncelle</h3>
                <form id="profile-update-form">
                    <label for="update-name">Ad Soyad:</label>
                    <input type="text" id="update-name" required>
                    <label for="update-email">Email:</label>
                    <input type="email" id="update-email" required>
                    <label for="update-dob">Doğum Tarihi:</label>
                    <input type="date" id="update-dob" required>
                    <label for="update-skills">Yetenekler (Virgülle Ayrılmış):</label>
                    <input type="text" id="update-skills" required>
                    <button type="submit" class="button">Güncelle</button>
                    <button type="button" class="button" id="cancel-update">İptal</button>
                </form>
            </div>
        </div>
    
        <div id="listings-tab" class="tab-content">
            <div class="filter">
                <label for="category-filter">Kategorilere Göre Filtrele:</label>
                <select id="category-filter">
                    <option value="">Tüm Kategoriler</option>
                </select>
            </div>
            <div id="listings-container">
            </div>
        </div>
        <div id="my-listings-tab" class="tab-content">
            <div id="my-listings-container">
            </div>
        </div>
        
        <div id="user-profile-modal" class="modal">
            <div class="modal-content">
                <span id="close-modal" class="close-button">&times;</span>
                <h2>Kullanıcı Profili</h2>
                <p><strong>Ad Soyad:</strong> <span id="modal-name">Yükleniyor...</span></p>
                <p><strong>Email:</strong> <span id="modal-email">Yükleniyor...</span></p>
                <p><strong>Doğum Tarihi:</strong> <span id="modal-dob">Yükleniyor...</span></p>
                <p><strong>Yetenekler:</strong> <span id="modal-skills">Yükleniyor...</span></p>
                <p><strong>Token Bakiyesi:</strong> <span id="modal-balance">0</span></p>
                <div id="send-message-section">
                    <h3>Mesaj Gönder</h3>
                    <form id="send-message-modal-form">
                        <textarea id="modal-message-content" placeholder="Mesajınızı yazın..." required></textarea>
                        <button type="submit">Gönder</button>
                    </form>
                </div>
                
            </div>
        </div>
        
       <div id="add-listing-tab" class="tab-content">
        <div class="form-container">
            <h2 class="form-title">Yeni İlan Ekle</h2>
            <form id="add-listing-form">
                <div class="form-group">
                    <label for="listing-title">Başlık:</label>
                    <input type="text" id="listing-title" name="title" class="form-input" placeholder="İlan başlığını yazın" required>
                </div>
                <div class="form-group">
                    <label for="listing-category">Kategori:</label>
                    <select id="listing-category" name="category" class="form-select" required>
                        <option value="" disabled selected>Kategori seçin</option>
                        <option value="cleaning">Temizlik</option>
                        <option value="plumbing">Tesisat</option>
                        <option value="gardening">Bahçe İşleri</option>
                        <option value="cooking">Yemek</option>
                        <option value="tutoring">Özel Ders</option>
                        <option value="babysitting">Çocuk Bakımı</option>
                        <option value="car_repair">Araba Tamiri</option>
                        <option value="pet_sitting">Evcil Hayvan Bakımı</option>
                        <option value="it_support">IT Desteği</option>
                        <option value="painting">Boyama</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="listing-details">Detaylar:</label>
                    <textarea id="listing-details" name="details" class="form-textarea" rows="4" placeholder="İlan detaylarını yazın..." required></textarea>
                </div>
                <div class="form-group">
                    <button type="submit" class="form-button">İLAN EKLE</button>
                </div>
            </form>
        </div>
    </div>
    

        <div id="traded-listings-tab" class="tab-content">
            <div id="traded-listings-container">
            </div>
        </div>
    </div>
    
    <div id="inbox-tab" class="tab-content">
        <h3>Konuşmalar</h3>
        <div id="conversations-container">
        </div>
        <div id="chat-container" style="display: none;">
            <button id="back-to-conversations">Geri</button>
            <h3 id="chat-with"></h3>
            <div id="chat-messages" class="chat-messages">
            </div>
            <form id="send-chat-message-form">
                <textarea id="chat-message-input" placeholder="Mesaj yazın..." required></textarea>
                <button type="submit">Gönder</button>
            </form>
        </div>
    </div>
    

    <script>

function showSnackbar(message, isSuccess = false, withRefresh = false) {
    let existingSnackbar = document.getElementById('global-snackbar');
    if (existingSnackbar) {
        existingSnackbar.remove();
    }

    const snackbar = document.createElement('div');
    snackbar.id = 'global-snackbar';
    snackbar.textContent = message;
    snackbar.style.position = 'fixed';
    snackbar.style.bottom = '-50px';
    snackbar.style.left = '50%';
    snackbar.style.transform = 'translateX(-50%)';
    snackbar.style.backgroundColor = isSuccess ? '#4CAF50' : '#D9534F';
    snackbar.style.color = '#fff';
    snackbar.style.padding = '14px 24px';
    snackbar.style.fontSize = '16px';
    snackbar.style.borderRadius = '8px';
    snackbar.style.zIndex = '9999';
    snackbar.style.transition = 'bottom 0.4s ease, opacity 0.4s ease';
    snackbar.style.opacity = '0';

    document.body.appendChild(snackbar);

    requestAnimationFrame(() => {
        snackbar.style.opacity = '1';
        snackbar.style.bottom = '40px';
    });

    setTimeout(() => {
        snackbar.style.opacity = '0';
        snackbar.style.bottom = '-50px';
        setTimeout(() => {
            if (snackbar.parentNode) {
                snackbar.parentNode.removeChild(snackbar);
            }
            if (withRefresh) {
                window.location.reload();
            }
        }, 400);
    }, 3000);
}


const categories = [
    {
        id: 'cleaning',
        name: 'Temizlik',
        description: 'Ev ve ofis temizliği hizmetleri.',
        barterPoints: 50,
        serviceType: 'physical',
        popular: true,
    },
    {
        id: 'gardening',
        name: 'Bahçe İşleri',
        description: 'Bahçe düzenleme, çim biçme ve bitki bakımı hizmetleri.',
        barterPoints: 40,
        serviceType: 'physical',
        popular: false,
    },
    {
        id: 'cooking',
        name: 'Yemek',
        description: 'Evde özel yemek yapma ve pişirme hizmetleri.',
        barterPoints: 30,
        serviceType: 'physical',
        popular: true,
    },
    {
        id: 'software-development',
        name: 'Yazılım Geliştirme',
        description: 'Web geliştirme, uygulama geliştirme ve diğer yazılım hizmetleri.',
        barterPoints: 100,
        serviceType: 'knowledge',
        popular: true,
    },
    {
        id: 'graphic-design',
        name: 'Grafik Tasarım',
        description: 'Logo tasarımı, poster tasarımı ve diğer grafik hizmetleri.',
        barterPoints: 70,
        serviceType: 'knowledge',
        popular: false,
    },
    {
        id: 'language-teaching',
        name: 'Dil Eğitimi',
        description: 'Yabancı dil öğretme ve özel ders hizmetleri.',
        barterPoints: 60,
        serviceType: 'knowledge',
        popular: true,
    },
];

document.querySelector('[data-tab="my-listings-tab"]')
    .addEventListener('click', () => {
        fetchMyListings();
    });

async function fetchMyListings() {
    try {
        const response = await fetch('http://localhost:5001/api/listings/my-listings', {
            headers: {
                Authorization: `Bearer ${localStorage.getItem('token')}`,
            },
        });
        if (!response.ok) {
            const errorData = await response.json();
            showSnackbar(errorData.message || 'Kendi ilanlarınız alınamadı.', false, false);
            return;
        }
        const data = await response.json();
        const myListingsContainer = document.getElementById('my-listings-container');
        myListingsContainer.innerHTML = '';

        data.forEach((listing) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <h3>${listing.title}</h3>
                <p>Detaylar: ${listing.details}</p>
                <p>Kategori: ${listing.category}</p>
                <!-- Kendime mesaj butonu eklemiyorum -->
            `;
            myListingsContainer.appendChild(card);
        });
    } catch (error) {
        console.error('Error fetching my listings:', error);
    }
}


async function fetchConversations() {
    try {
        const response = await fetch('http://localhost:5001/api/messages/conversations', {
            headers: {
                Authorization: `Bearer ${localStorage.getItem('token')}`,
            },
        });

        if (response.ok) {
            const conversations = await response.json();
            const container = document.getElementById('conversations-container');
            container.innerHTML = ''; 

            conversations.forEach(conversation => {
                const conversationCard = document.createElement('div');
                conversationCard.className = 'conversation-card';
                conversationCard.innerHTML = `
                    <p><strong>${conversation.user?.name || 'Bilinmiyor'}</strong></p>
                    <p>${conversation.messages?.[conversation.messages.length - 1]?.content || '...'}</p>
                `;
                conversationCard.addEventListener('click', () => openChat(conversation));
                container.appendChild(conversationCard);
            });
        } else {
            const errorData = await response.json();
            showSnackbar(errorData.message || 'Konuşmalar alınamadı.', false, false);
        }
    } catch (error) {
        console.error('Konuşmalar alınırken hata oluştu:', error);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    fetchConversations(); 
});


function openChat(conversation) {
    document.getElementById('conversations-container').style.display = 'none';
    document.getElementById('chat-container').style.display = 'block';

    const chatWith = document.getElementById('chat-with');
    chatWith.textContent = `Konuşma: ${conversation.user?.name || 'Bilinmiyor'}`;

    const chatMessages = document.getElementById('chat-messages');
    chatMessages.innerHTML = ''; 

    conversation.messages.forEach(message => {
        const messageCard = document.createElement('div');

        if (message.sender._id === localStorage.getItem('userId')) {
            messageCard.className = 'message-outgoing'; 
        } else {
            messageCard.className = 'message-incoming'; 
        }

        messageCard.innerHTML = `
            <p>${message.content}</p>
            <p><small>${new Date(message.createdAt).toLocaleString()}</small></p>
        `;
        chatMessages.appendChild(messageCard); 
    });

    const sendMessageForm = document.getElementById('send-chat-message-form');
    sendMessageForm.onsubmit = (event) => sendMessage(event, conversation.user._id);
}

function displayMessages(data) {
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.innerHTML = ''; 

    const currentUserId = localStorage.getItem('userId');
    console.log("currentUserId:", currentUserId); 

    const combinedMessages = [...data.received, ...data.sent];

    combinedMessages.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));

    combinedMessages.forEach((message, index) => {
        console.log(`Message #${index} sender ID:`, message?.sender?._id);

        const messageCard = document.createElement('div');
        
        if (message.sender?._id === currentUserId) {
            console.log(`Message #${index} is from ME -> outgoing`);
            messageCard.className = 'message-outgoing';
            messageCard.innerHTML = `
                <p><strong>Ben (You)</strong></p>
                <p>${message.content}</p>
                <p><small>${new Date(message.createdAt).toLocaleString()}</small></p>
            `;
        } else {
            console.log(`Message #${index} is from OTHER -> incoming`);
            messageCard.className = 'message-incoming';
            messageCard.innerHTML = `
                <p><strong>${message.sender?.name || message.sender?.email || "Karşı taraf"}</strong></p>
                <p>${message.content}</p>
                <p><small>${new Date(message.createdAt).toLocaleString()}</small></p>
            `;
        }

        chatMessages.appendChild(messageCard);
    });
}



async function fetchAndDisplayMessages() {
    try {
        const response = await fetch('http://localhost:5001/api/messages', {
            headers: {
                Authorization: `Bearer ${localStorage.getItem('token')}`,
            },
        });

        if (response.ok) {
            const data = await response.json();
            displayMessages(data); 
        } else {
            console.error('Mesajlar alınamadı.');
        }
    } catch (error) {
        console.error('Mesajlar alınırken hata oluştu:', error);
    }
}
document.addEventListener('DOMContentLoaded', fetchAndDisplayMessages);




async function sendMessage(event, receiverId) {
    event.preventDefault();
    const messageInput = document.getElementById('chat-message-input');
    const content = messageInput.value.trim();

    if (!content) return;

    try {
        const response = await fetch('http://localhost:5001/api/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${localStorage.getItem('token')}`,
            },
            body: JSON.stringify({ receiverId, content }),
        });

        if (response.ok) {
            const { data: newMessage } = await response.json();
            messageInput.value = '';

            const chatMessages = document.getElementById('chat-messages');
            const messageCard = document.createElement('div');
            messageCard.className = 'message-outgoing';
            messageCard.innerHTML = `
                <p><strong>Ben (You)</strong></p>
                <p>${newMessage.content}</p>
                <p><small>${new Date(newMessage.createdAt).toLocaleString()}</small></p>
            `;
            chatMessages.appendChild(messageCard);

            chatMessages.scrollTop = chatMessages.scrollHeight;
        } else {
            const errorData = await response.json();
            showSnackbar(errorData.message || 'Mesaj gönderilemedi.', false, false);
        }
    } catch (error) {
        console.error('Mesaj gönderim hatası:', error);
        showSnackbar('Mesaj gönderilirken bir hata oluştu.', false, false);
    }
}





document.getElementById('back-to-conversations').addEventListener('click', () => {
    document.getElementById('chat-container').style.display = 'none';
    document.getElementById('conversations-container').style.display = 'block';
});

document.getElementById('send-message-modal-form').addEventListener('submit', async (event) => {
    event.preventDefault();
    const content = document.getElementById('modal-message-content').value.trim();
    const receiverId = document.getElementById('modal-name').dataset.userId;

    if (!content) {
        showSnackbar('Mesaj içeriği boş olamaz!', false, false);
        return;
    }

    try {
        const response = await fetch('http://localhost:5001/api/messages', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${localStorage.getItem('token')}`,
            },
            body: JSON.stringify({ receiverId, content }),
        });

        if (response.ok) {
            showSnackbar('Mesaj başarıyla gönderildi!', true, false);
            document.getElementById('modal-message-content').value = '';
        } else {
            const errorData = await response.json();
            showSnackbar(errorData.message || 'Mesaj gönderilemedi.', false, false);
        }
    } catch (error) {
        console.error('Mesaj gönderim hatası:', error);
        showSnackbar('Mesaj gönderilirken bir hata oluştu.', false, false);
    }
});

async function fetchMessages() {
    try {
        const response = await fetch('http://localhost:5001/api/messages', {
            headers: {
                Authorization: `Bearer ${localStorage.getItem('token')}`,
            },
        });

        if (response.ok) {
            const data = await response.json();
            const receivedContainer = document.getElementById('received-messages-container');
            receivedContainer.innerHTML = '';
            data.received.forEach(message => {
                const messageCard = document.createElement('div');
                messageCard.className = 'message-card';
                messageCard.innerHTML = `
                    <p><strong>Kimden:</strong> ${message.sender.name}</p>
                    <p>${message.content}</p>
                    <p><small>${new Date(message.createdAt).toLocaleString()}</small></p>
                `;
                receivedContainer.appendChild(messageCard);
            });

            const sentContainer = document.getElementById('sent-messages-container');
            sentContainer.innerHTML = '';
            data.sent.forEach(message => {
                const messageCard = document.createElement('div');
                messageCard.className = 'message-card';
                messageCard.innerHTML = `
                    <p><strong>Kime:</strong> ${message.receiver.name}</p>
                    <p>${message.content}</p>
                    <p><small>${new Date(message.createdAt).toLocaleString()}</small></p>
                `;
                sentContainer.appendChild(messageCard);
            });
        } else {
            const errorData = await response.json();
            showSnackbar(errorData.message || 'Mesajlar alınamadı.', false, false);
        }
    } catch (error) {
        console.error('Mesajlar alınırken hata oluştu:', error);
    }
}

document.querySelector('[data-tab="inbox-tab"]').addEventListener('click', fetchMessages);

async function showUserProfile(userId) {
    document.getElementById('modal-name').dataset.userId = userId;

    console.log('showUserProfile called with userId:', userId); 
    if (!userId) {
        console.error('User ID is undefined or invalid.');
        showSnackbar('Geçersiz kullanıcı ID\'si.', false, false);
        return;
    }

    try {
        const response = await fetch(`http://localhost:5001/api/users/${userId}`, {
            headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
        });

        if (!response.ok) {
            const errorData = await response.json();
            console.error('Error fetching user profile:', errorData.message);
            showSnackbar(errorData.message || 'Kullanıcı profili alınamadı.', false, false);
            return;
        }

        const data = await response.json();
        console.log('Fetched user profile:', data); 

        document.getElementById('modal-name').textContent = data.name || 'Yükleniyor...';
        document.getElementById('modal-email').textContent = data.email || 'Yükleniyor...';
        document.getElementById('modal-dob').textContent = data.dob || 'Yükleniyor...';
        document.getElementById('modal-skills').textContent = data.skills?.join(', ') || 'Yükleniyor...';
        document.getElementById('modal-balance').textContent = data.tokenBalance || '0';
        document.getElementById('user-profile-modal').style.display = 'block';
    } catch (error) {
        console.error('Fetch error:', error);
        showSnackbar('Kullanıcı bilgisi alınırken bir hata oluştu.', false, false);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const userLinks = document.querySelectorAll('.user-link'); 
    console.log('User links found:', userLinks.length); 

    userLinks.forEach(link => {
        console.log('User Link Data:', link.getAttribute('data-user-id')); 
        link.addEventListener('click', (event) => {
            event.preventDefault(); 
            const userId = link.getAttribute('data-user-id');
            console.log('User ID clicked:', userId); 
            if (userId) {
                showUserProfile(userId); 
            } else {
                console.error('User ID is missing or invalid');
                showSnackbar('Geçersiz kullanıcı ID\'si.', false, false);
            }
        });
    });
});

const modal = document.getElementById('user-profile-modal');
const closeModalButton = document.getElementById('close-modal');

closeModalButton.addEventListener('click', () => {
    modal.style.display = 'none';
});

window.addEventListener('click', (event) => {
    if (event.target === modal) {
        modal.style.display = 'none';
    }
});


function populateCategoryFilter() {
    const categoryFilter = document.getElementById('category-filter');
    categoryFilter.innerHTML = '<option value="">Tüm Kategoriler</option>'; 

    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = `${category.name} (Puan: ${category.barterPoints})`;
        categoryFilter.appendChild(option);
    });
}

document.addEventListener('DOMContentLoaded', () => {
    populateCategoryFilter();
});

function displayCategoryDetails() {
    const categoryInfo = document.getElementById('category-info');
    categoryInfo.innerHTML = '';

    categories.forEach(category => {
        const categoryCard = document.createElement('div');
        categoryCard.className = 'category-card';
        categoryCard.innerHTML = `
            <h3>${category.name}</h3>
            <p>${category.description}</p>
            <p><strong>Hizmet Tipi:</strong> ${category.serviceType === 'physical' ? 'Fiziksel' : 'Bilgi Temelli'}</p>
            <p><strong>Barter Puanı:</strong> ${category.barterPoints}</p>
            <p><strong>Popülerlik:</strong> ${category.popular ? 'Popüler' : 'Az Tercih Edilen'}</p>
        `;
        categoryInfo.appendChild(categoryCard);
    });
}

document.addEventListener('DOMContentLoaded', () => {
    displayCategoryDetails();
});



document.addEventListener('DOMContentLoaded', () => {
    const updateButton = document.getElementById('update-profile-button');
    const updateForm = document.getElementById('update-profile-form');
    const cancelButton = document.getElementById('cancel-update');
    const profileUpdateForm = document.getElementById('profile-update-form');

    updateButton.addEventListener('click', () => {
        const name = document.getElementById('profile-name').textContent.split(': ')[1];
        const email = document.getElementById('profile-email').textContent;
        const dob = document.getElementById('profile-dob').textContent;
        const skills = document.getElementById('profile-skills').textContent;

        document.getElementById('update-name').value = name;
        document.getElementById('update-email').value = email;
        document.getElementById('update-dob').value = dob;
        document.getElementById('update-skills').value = skills;

        updateForm.style.display = 'block';
    });

    cancelButton.addEventListener('click', () => {
        updateForm.style.display = 'none';
    });

    profileUpdateForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        const updatedData = {
            name: document.getElementById('update-name').value,
            email: document.getElementById('update-email').value,
            dob: document.getElementById('update-dob').value,
            skills: document.getElementById('update-skills').value.split(',').map(skill => skill.trim()),
        };

        try {
            const response = await fetch('http://localhost:5001/api/auth/update-profile', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${localStorage.getItem('token')}`,
                },
                body: JSON.stringify(updatedData),
            });

            if (response.ok) {
                showSnackbar('Profil başarıyla güncellendi!', true, false);
                fetchProfile();
                updateForm.style.display = 'none';
            } else {
                const data = await response.json();
                showSnackbar(data.message || 'Güncelleme sırasında bir hata oluştu.', false, false);

            }
        } catch (error) {
            console.error('Error updating profile:', error);
            showSnackbar('Güncelleme sırasında bir hata oluştu.', false, false);
        }
    });
});


document.getElementById('logout-button').addEventListener('click', () => {
    localStorage.removeItem('token');

    window.location.href = 'index.html';
});


const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            const profileCard = document.getElementById('profile-card');
            const listingsContainer = document.getElementById('listings-container');
            const categoryFilter = document.getElementById('category-filter');
            const tradedListingsContainer = document.getElementById('traded-listings-container');
            const addListingForm = document.getElementById('add-listing-form');

            async function fetchProfile() {
  try {
      const response = await fetch('http://localhost:5001/api/auth/profile', {
          headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
      });
      const data = await response.json();

      if (response.ok) {
          document.getElementById('profile-name').textContent = `Ad Soyad: ${data.name}`;
          document.getElementById('profile-email').textContent = data.email;
          document.getElementById('profile-dob').textContent = data.dob;
          document.getElementById('profile-balance').textContent = data.tokenBalance; 
          document.getElementById('profile-skills').textContent = data.skills.join(', ');
      } else {
        showSnackbar(data.message || 'Profil bilgileri alınamadı.', false, false);
      }
  } catch (error) {
      console.error('Error fetching profile:', error);
  }
}


async function fetchListings(category = '') {
    try {
        const response = await fetch(`http://localhost:5001/api/listings?category=${category}`);
        const data = await response.json();
        listingsContainer.innerHTML = '';
        data.forEach((listing) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <h3>${listing.title}</h3>
                <p>Detaylar: ${listing.details}</p>
                <p>Kategori: ${listing.category}</p>
                <p><strong>Gerekli Token:</strong> ${listing.tokenCost || 0}</p>
                <p><strong>İlan Sahibi:</strong> 
                    ${listing.user?._id === localStorage.getItem('userId')
                        ? '(Benim İlanım)'
                        : `<a href="javascript:void(0)" class="user-link" data-user-id="${listing.user?._id || ''}">
                             ${listing.user?.name || 'Bilinmiyor'}
                           </a>`
                    }
                </p>
                ${
                    listing.user?._id !== localStorage.getItem('userId') && !listing.isTraded
                    ? `<button class="takas-button" data-id="${listing._id}">Takas</button>`
                    : ''
                }
            `;
            listingsContainer.appendChild(card);
        });

        attachTakasButtonListeners();
        attachUserLinkListeners(); 
    } catch (error) {
        console.error('Error fetching listings:', error);
    }
}

function attachTakasButtonListeners() {
    document.querySelectorAll('.takas-button').forEach(btn => {
        btn.addEventListener('click', () => {
            const listingId = btn.getAttribute('data-id');
            
            openTakasModal(listingId);
        });
    });
}


let selectedOtherListingId = null;


function openTakasModal(otherListingId) {
    selectedOtherListingId = otherListingId;
    fetchMyListingsForModal().then(myListings => {
        const selectEl = document.getElementById('my-listing-select');
        selectEl.innerHTML = '';

        myListings.forEach(myListing => {
            if (!myListing.isTraded) {
                const option = document.createElement('option');
                option.value = myListing._id;
                option.textContent = `${myListing.title} (TokenCost: ${myListing.tokenCost || 0})`;
                selectEl.appendChild(option);
            }
        });

        document.getElementById('takas-modal').style.display = 'block';
    });
}

async function fetchMyListingsForModal() {
    try {
        const response = await fetch('http://localhost:5001/api/listings/my-listings', {
            headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
        });
        if (!response.ok) {
            const errorData = await response.json();
            showSnackbar(errorData.message || 'Kendi ilanlarınız alınamadı.', false, false);
            return [];
        }
        const data = await response.json();
        return data; 
    } catch (error) {
        console.error('Error fetching my listings:', error);
        return [];
    }
}

document.getElementById('confirm-takas-btn').addEventListener('click', () => {
    const myListingId = document.getElementById('my-listing-select').value;
    handleCrossTrade(myListingId, selectedOtherListingId);
});
document.getElementById('close-takas-modal-btn').addEventListener('click', () => {
    document.getElementById('takas-modal').style.display = 'none';
});

async function handleCrossTrade(myListingId, otherListingId) {
    try {
        const response = await fetch('http://localhost:5001/api/listings/crossTrade', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({ myListingId, otherListingId })
        });

        const data = await response.json();
        if (!response.ok) {
            showSnackbar(data.message || 'Takas yapılamadı', false, false);
            return;
        }

        showSnackbar('Çapraz takas başarılı!', true, false); 
        fetchProfile();
        fetchListings();
        document.getElementById('takas-modal').style.display = 'none';
    } catch (error) {
        console.error('Cross trade error:', error);
    }
}



async function handleTakas(listingId) {
    try {
        const response = await fetch('http://localhost:5001/api/listings/takas', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({ listingId })
        });

        if (!response.ok) {
            const errorData = await response.json();
            showSnackbar(errorData.message || 'Takas yapılamadı.', false, false);
            return;
        }
        const data = await response.json();
        showSnackbar('Takas başarıyla gerçekleştirildi!', true, false);

        fetchProfile();
        fetchListings();
    } catch (error) {
        console.error('Takas hata:', error);
    }
}



function attachUserLinkListeners() {
    const userLinks = document.querySelectorAll('.user-link');
    console.log('User links found:', userLinks.length); 

    userLinks.forEach(link => {
        console.log('User Link Data:', link.getAttribute('data-user-id')); 
        link.addEventListener('click', (event) => {
            event.preventDefault(); 
            const userId = link.getAttribute('data-user-id');
            console.log('User ID clicked:', userId); 
            if (userId) {
                showUserProfile(userId); 
            } else {
                console.error('User ID is missing or invalid');
                showSnackbar('Geçersiz kullanıcı ID\'si.', false, false);
            }
        });
    });
}

document.addEventListener('DOMContentLoaded', () => {
    fetchListings(); 
});


            async function fetchTradedListings() {
                try {
                    const response = await fetch('http://localhost:5001/api/listings/traded', {
                        headers: { Authorization: `Bearer ${localStorage.getItem('token')}` },
                    });
                    const data = await response.json();
                    tradedListingsContainer.innerHTML = '';
                    data.forEach((listing) => {
                        const card = document.createElement('div');
                        card.className = 'card';
                        card.innerHTML = `
                            <h3>${listing.title}</h3>
                            <p>Detaylar: ${listing.details}</p>
                            <p>Takas Tarihi: ${listing.tradeDate}</p>
                        `;
                        tradedListingsContainer.appendChild(card);
                    });
                } catch (error) {
                    console.error('Error fetching traded listings:', error);
                }
            }

            addListingForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const title = document.getElementById('listing-title').value;
                const category = document.getElementById('listing-category').value;
                const details = document.getElementById('listing-details').value;

                try {
                    const response = await fetch('http://localhost:5001/api/listings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${localStorage.getItem('token')}`,
                        },
                        body: JSON.stringify({ title, category, details }),
                    });

                    if (response.ok) {
                        showSnackbar('İlan başarıyla eklendi!', true, false);
                        fetchListings();
                    } else {
                        const data = await response.json();
                        showSnackbar(data.message || 'İlan eklenemedi.', false, false);
                    }
                } catch (error) {
                    console.error('Error adding listing:', error);
                }
            });

            categoryFilter.addEventListener('change', (event) => {
                fetchListings(event.target.value);
            });

            fetchProfile();
            fetchListings();
            fetchTradedListings();
        });
    </script>


<div id="takas-modal" class="modal" style="display: none;">
    <div class="modal-content takas-modal-content">
        <span id="close-takas-modal-btn" class="close-button">&times;</span>
        <h2>İlan Seç ve Takas Yap</h2>
        <p>Kendi ilanlarından hangisiyle takas yapmak istiyorsun?</p>
        <select id="my-listing-select"></select>
        <br><br>
        <button id="confirm-takas-btn" class="modal-button">Takas Yap</button>
    </div>
</div>



</body>
</html>
